{% extends 'capsule/base.html' %}

{% block title %}Create Outfit{% endblock %}

{% load crispy_forms_tags %}

{% block content %}
<h1>Create Outfit</h1>
<form method="post" id="outfitForm">
    {% csrf_token %}
    {{ form|crispy }}
    <button type="submit" class="btn btn-primary">Save Outfit</button>
</form>
<hr>
<h2>Items</h2>
<div class="items-container">
    {% for item in items %}
        <div class="item" id="item-{{ item.id }}" data-id="{{ item.id }}">
            <img src="{{ item.image.url }}" alt="{{ item.name }}" width="100">
            <p>{{ item.name }}</p>
        </div>
    {% endfor %}
</div>
<hr>
<h2>Canvas</h2>
<div id="canvas" class="canvas" style="width: 100%; height: 600px; border: 1px solid #ccc; background-color: #f9f9f9; position: relative; overflow: auto;">
    <p>Drag items here to create your outfit</p>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>

<script>
    $(function() {
        var maxZIndex = 1;
    
        $(".item").draggable({
            helper: "clone",
            appendTo: 'body',
            zIndex: 10000
        });
    
        $("#canvas").droppable({
            accept: ".item",
            drop: function(event, ui) {
                var itemId = ui.helper.data("id");
    
                // Check if the item is already in the canvas
                if ($("#canvas .item[data-id='" + itemId + "']").length === 0) {
                    var clone = ui.helper.clone();
                    clone.removeAttr("style");
                    clone.css({
                        width: '200px',  // Set image width to 100px
                        height: 'auto',  // Set image height to auto
                        position: 'absolute',
                        zIndex: maxZIndex++
                    });
                    clone.find("img").css({
                        width: '200px',  // Set image width to 100px
                        height: 'auto'   // Set image height to auto
                    });
                    clone.appendTo("#canvas").draggable({
                        containment: "#canvas"
                    }).attr("data-id", itemId);
                    addClickHandler(clone);
                }
            }
        });
    
        function addClickHandler(element) {
            element.on('click', function() {
                $(this).css('z-index', maxZIndex++);
            });
        }
    
        // Attach click handlers to any existing items in the canvas
        $("#canvas .item").each(function() {
            addClickHandler($(this));
        });
    
        $("#outfitForm").submit(function(e) {
            var selectedItems = [];
            $("#canvas .item").each(function() {
                selectedItems.push($(this).data("id"));
            });
    
            $('<input>').attr({
                type: 'hidden',
                name: 'items',
                value: JSON.stringify(selectedItems)
            }).appendTo("#outfitForm");
    
            return true;
        });
    });
</script>
{% endblock %}
